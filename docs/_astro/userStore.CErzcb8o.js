const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/@supabase.dO6uEFJg.js","_astro/Page.astro_astro_type_script_index_0_lang.tntsxO7H.js","_astro/react.C3Okw6ig.js","_astro/react-dom.BGHTHZuc.js","_astro/svelte.BVVFYaGB.js","_astro/esm-env.rsSWfq8L.js"])))=>i.map(i=>d[i]);
import{_ as h}from"./Page.astro_astro_type_script_index_0_lang.tntsxO7H.js";import{p as _}from"./@nanostores.D3epgRK9.js";import{a as m}from"./nanostores.B6d4-zKA.js";const f=_("user-authenticated",!1,{encode:e=>String(e),decode:e=>e==="true"}),v=m(!1),w=m(null),g=_("user-session",null,{encode:JSON.stringify,decode:e=>e?JSON.parse(e):null}),r=_("user-profile",null,{encode:JSON.stringify,decode:e=>e?JSON.parse(e):null}),d=_("user-preferences",{theme:"dark",language:"en",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,email_notifications:!0,push_notifications:!1,content_filter:"mild",autoplay_videos:!0,show_nsfw:!1},{encode:JSON.stringify,decode:e=>e?JSON.parse(e):void 0}),i=m({liked_memes:new Set,viewed_memes:new Set,shared_memes:new Set,recently_viewed:[],bookmarked_memes:new Set}),S=m({drafts:[],uploaded_memes:[],upload_history:[]}),c=m({followers:[],following:[],blocked_users:[],muted_users:[]}),u={setAuth:(e,t)=>{if(f.set(!!e),g.set(e),e?.user&&t){const s={id:e.user.id,uuid:e.user.id,email:e.user.email,username:e.user.user_metadata?.username||t.username,avatar_url:e.user.user_metadata?.avatar_url||t.avatar_url,full_name:e.user.user_metadata?.full_name||t.full_name,display_name:t.display_name||e.user.user_metadata?.username||t.username,bio:t.bio,website:t.website,location:t.location,user_metadata:e.user.user_metadata,app_metadata:e.user.app_metadata,email_verified:!!e.user.email_confirmed_at,phone_verified:!!e.user.phone_confirmed_at,is_premium:t.is_premium||!1,is_creator:t.is_creator||!1,is_admin:t.is_admin||!1,created_at:e.user.created_at,updated_at:e.user.updated_at,last_sign_in_at:e.user.last_sign_in_at,preferences:{theme:t.preferences&&t.preferences.theme!==void 0?t.preferences.theme:d.get()?.theme??"dark",language:t.preferences&&t.preferences.language!==void 0?t.preferences.language:d.get()?.language??"en",timezone:t.preferences&&t.preferences.timezone!==void 0?t.preferences.timezone:d.get()?.timezone??Intl.DateTimeFormat().resolvedOptions().timeZone,email_notifications:t.preferences&&t.preferences.email_notifications!==void 0?t.preferences.email_notifications:d.get()?.email_notifications??!0,push_notifications:t.preferences&&t.preferences.push_notifications!==void 0?t.preferences.push_notifications:d.get()?.push_notifications??!1,content_filter:t.preferences&&t.preferences.content_filter!==void 0?t.preferences.content_filter:d.get()?.content_filter??"mild",autoplay_videos:t.preferences&&t.preferences.autoplay_videos!==void 0?t.preferences.autoplay_videos:d.get()?.autoplay_videos??!0,show_nsfw:t.preferences&&t.preferences.show_nsfw!==void 0?t.preferences.show_nsfw:d.get()?.show_nsfw??!1},stats:t.stats||{memes_created:0,memes_liked:0,followers_count:0,following_count:0,total_views:0,total_likes_received:0,join_date:e.user.created_at,last_active:new Date().toISOString()}};r.set(s)}},logout:()=>{f.set(!1),g.set(null),r.set(null),w.set(null),i.set({liked_memes:new Set,viewed_memes:new Set,shared_memes:new Set,recently_viewed:[],bookmarked_memes:new Set})},setLoading:e=>{v.set(e)},setError:e=>{w.set(e)},updateProfile:e=>{const t=r.get();t&&r.set({...t,...e,updated_at:new Date().toISOString()})},updatePreferences:e=>{const s={...d.get(),...e},n={theme:s.theme??"dark",language:s.language??"en",timezone:s.timezone??Intl.DateTimeFormat().resolvedOptions().timeZone,email_notifications:s.email_notifications??!0,push_notifications:s.push_notifications??!1,content_filter:s.content_filter??"mild",autoplay_videos:s.autoplay_videos??!0,show_nsfw:s.show_nsfw??!1};d.set(n);const l=r.get();l&&r.set({...l,preferences:n,updated_at:new Date().toISOString()})},updateStats:e=>{const t=r.get();t?.stats&&r.set({...t,stats:{...t.stats,...e,last_active:new Date().toISOString()},updated_at:new Date().toISOString()})},updateBasicProfile:e=>{const t=r.get();t&&r.set({...t,...e,updated_at:new Date().toISOString()})},updateAvatar:e=>{const t=r.get();t&&r.set({...t,avatar_url:e,updated_at:new Date().toISOString()})},updateAccountSettings:e=>{const t=r.get();t&&r.set({...t,...e,updated_at:new Date().toISOString()})},validateProfile:()=>{const e=r.get();if(!e)return{valid:!1,errors:["No profile found"]};const t=[];return e.email||t.push("Email is required"),e.username&&e.username.length<3&&t.push("Username must be at least 3 characters"),e.bio&&e.bio.length>500&&t.push("Bio must be less than 500 characters"),e.website&&!e.website.match(/^https?:\/\/.+/)&&t.push("Website must be a valid URL"),{valid:t.length===0,errors:t}},likeMeme:e=>{const t=i.get(),s=new Set(t.liked_memes);s.add(e),i.set({...t,liked_memes:s});const n=r.get();n?.stats&&u.updateStats({memes_liked:n.stats.memes_liked+1})},unlikeMeme:e=>{const t=i.get(),s=new Set(t.liked_memes);s.delete(e),i.set({...t,liked_memes:s});const n=r.get();n?.stats&&u.updateStats({memes_liked:Math.max(0,n.stats.memes_liked-1)})},viewMeme:e=>{const t=i.get(),s=new Set(t.viewed_memes);s.add(e);const n=[e,...t.recently_viewed.filter(l=>l!==e)].slice(0,50);i.set({...t,viewed_memes:s,recently_viewed:n})},bookmarkMeme:e=>{const t=i.get(),s=new Set(t.bookmarked_memes);s.has(e)?s.delete(e):s.add(e),i.set({...t,bookmarked_memes:s})},shareMeme:e=>{const t=i.get(),s=new Set(t.shared_memes);s.add(e),i.set({...t,shared_memes:s})},followUser:e=>{const t=c.get(),s=[...t.following];if(!s.includes(e)){s.push(e),c.set({...t,following:s});const n=r.get();n?.stats&&u.updateStats({following_count:n.stats.following_count+1})}},unfollowUser:e=>{const t=c.get(),s=t.following.filter(l=>l!==e);c.set({...t,following:s});const n=r.get();n?.stats&&u.updateStats({following_count:Math.max(0,n.stats.following_count-1)})},blockUser:e=>{const t=c.get(),s=[...t.blocked_users];if(!s.includes(e)){s.push(e);const n=t.following.filter(l=>l!==e);c.set({...t,blocked_users:s,following:n})}},unblockUser:e=>{const t=c.get(),s=t.blocked_users.filter(n=>n!==e);c.set({...t,blocked_users:s})},isLiked:e=>i.get().liked_memes.has(e),isBookmarked:e=>i.get().bookmarked_memes.has(e),isFollowing:e=>c.get().following.includes(e),isBlocked:e=>c.get().blocked_users.includes(e),getDisplayName:()=>{const e=r.get();return e?.display_name||e?.username||e?.full_name||e?.email?.split("@")[0]||"Anonymous User"},getAvatarUrl:()=>{const e=r.get();return e?.avatar_url||`https://api.dicebear.com/7.x/avataaars/svg?seed=${e?.email||"default"}`},resetUserData:()=>{u.logout(),d.set({theme:"dark",language:"en",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,email_notifications:!0,push_notifications:!1,content_filter:"mild",autoplay_videos:!0,show_nsfw:!1}),S.set({drafts:[],uploaded_memes:[],upload_history:[]}),c.set({followers:[],following:[],blocked_users:[],muted_users:[]})}},k=async()=>{try{const{createClient:e}=await h(async()=>{const{createClient:a}=await import("./@supabase.dO6uEFJg.js").then(o=>o.i);return{createClient:a}},__vite__mapDeps([0,1,2,3,4,5])),t=void 0,s=void 0;if(!t||!s){console.warn("Supabase configuration missing");return}const n=e(t,s),l=g.get();if(f.get()&&l)try{const{data:a,error:o}=await n.auth.setSession(l);o||!a.session?(console.log("Persisted session invalid, clearing state"),u.logout()):(console.log("Persisted session valid, updating profile"),u.setAuth(a.session,{id:a.session.user.id,email:a.session.user.email,username:a.session.user.user_metadata?.username||a.session.user.user_metadata?.user_name||a.session.user.user_metadata?.name,avatar_url:a.session.user.user_metadata?.avatar_url,full_name:a.session.user.user_metadata?.full_name}))}catch(a){console.log("Error validating persisted session:",a),u.logout()}else{const{data:{session:a},error:o}=await n.auth.getSession();if(o){console.error("Error getting session:",o);return}a?.user&&u.setAuth(a,{id:a.user.id,email:a.user.email,username:a.user.user_metadata?.username||a.user.user_metadata?.user_name||a.user.user_metadata?.name,avatar_url:a.user.user_metadata?.avatar_url,full_name:a.user.user_metadata?.full_name})}const{data:{subscription:p}}=n.auth.onAuthStateChange((a,o)=>{console.log("Auth state change:",a,o?.user?.email),a==="SIGNED_IN"&&o?.user?u.setAuth(o,{id:o.user.id,email:o.user.email,username:o.user.user_metadata?.username||o.user.user_metadata?.user_name||o.user.user_metadata?.name,avatar_url:o.user.user_metadata?.avatar_url,full_name:o.user.user_metadata?.full_name}):a==="SIGNED_OUT"&&u.logout()});return p}catch(e){console.error("Auth initialization failed:",e)}};typeof window<"u"&&k();const b=m(""),y=m("");r.subscribe(e=>{b.set(u.getDisplayName()),y.set(u.getAvatarUrl())});export{v as a,r as b,f as i,u};
