import{p as i}from"./@nanostores.ZMiXd8TN.js";import{s as d}from"./supabaseClient.BpnhpdKG.js";import{a as f}from"./nanostores.B6d4-zKA.js";const p=f(null),m=f(null),U=i("meme:user:id",void 0),g=i("meme:user:email",void 0),a=i("meme:user:username",void 0);function v(e){return e?JSON.stringify(e):""}function S(e){return e?JSON.parse(e):void 0}const o=i("meme:user:profile",void 0,{encode:v,decode:S});async function h(){try{const{data:{user:e},error:t}=await d.auth.getUser();if(t){console.error("[syncSupabaseUser] Error getting user:",t),c();return}if(e){p.set(e),U.set(e.id),g.set(e.email||void 0);const s=e.user_metadata?.username,n=a.get(),r=s||n;r?(m.set(r),a.set(r),localStorage.setItem("memeUsername",r),localStorage.setItem("memeUserId",e.id),localStorage.setItem("memeUserEmail",e.email||""),localStorage.setItem("isMember","true"),await y(e.id)):(m.set(null),a.set(void 0))}else c()}catch(e){console.error("[syncSupabaseUser] Unexpected error:",e),c()}}function c(){p.set(null),U.set(void 0),g.set(void 0),m.set(null),a.set(void 0),o.set(void 0),typeof window<"u"&&(localStorage.removeItem("memeUsername"),localStorage.removeItem("memeUserId"),localStorage.removeItem("memeUserEmail"),localStorage.removeItem("onboardingComplete"),localStorage.setItem("isMember","false"))}async function y(e,t=!0){if(!e){o.set(void 0);return}try{const{data:s,error:n}=await d.rpc("get_user_balance_context",{p_identifier:e,use_cache:t});if(n){console.error("[syncUserMemeProfile] RPC error:",n),o.set(void 0);return}if(s&&s.length>0){const r=s[0],l={user_id:r.user_id||e,username:r.username||null,role:r.role||null,credits:r.credits??null,khash:r.khash??null,level:r.level??null,created_at:r.created_at||new Date().toISOString(),meme_points:null,total_memes:null,total_likes:null};o.set(l),l.username&&!a.get()&&(a.set(l.username),m.set(l.username),typeof window<"u"&&localStorage.setItem("memeUsername",l.username)),console.log("[syncUserMemeProfile] Profile synced from RPC:",l)}else o.set(void 0),console.log("[syncUserMemeProfile] No profile data returned for identifier:",e)}catch(s){console.error("[syncUserMemeProfile] Failed to fetch profile:",s),o.set(void 0)}}function u(e){return typeof e!="string"?!1:/^[a-z0-9_-]{3,30}$/.test(e)}function E(){const e=m.get(),t=a.get(),s=o.get(),n=!!(u(e)||u(t)),r=!!(s&&s.meme_points!==null);return n&&r}export{m as a,p as b,U as c,y as d,E as i,h as s,o as u};
