import{r as x,j as e}from"./react.r4gJI2bz.js";import{u as y}from"./react-hook-form.DXidjym_.js";import{u as l}from"./@nanostores.BtbAb2LT.js";import{s as k}from"./supabaseClient.DuTUdOkW.js";import{s as S,a as h,v as p,b as U,u as E,c as _,d as v,e as z}from"./userstate.D_-DwhNB.js";import"./@supabase.C0lIp2d2.js";import"./Page.astro_astro_type_script_index_0_lang.DRsRsscW.js";import"./react-dom.DZm4RTKV.js";import"./svelte.BVVFYaGB.js";import"./esm-env.rsSWfq8L.js";import"./nanostores.B6d4-zKA.js";const A=/^[a-z0-9_-]{3,30}$/,D=()=>{const r=l(E),u=l(v),t=l(_),o=l(U),{register:j,handleSubmit:N,formState:{errors:f,isSubmitting:n},setError:m,setValue:C}=y(),[d,i]=x.useState(null);x.useEffect(()=>{S()},[]),x.useEffect(()=>{o&&h(o)},[o]);const w=async s=>{if(i(null),!r){m("username",{type:"manual",message:"User not logged in."});return}try{const{data:c,error:b}=await k.functions.invoke("register-user",{body:{username:s.username}});if(b){m("username",{type:"manual",message:b.message||"Registration failed."});return}v.set(s.username),z.set(s.username),typeof window<"u"&&(localStorage.setItem("memeUsername",s.username),localStorage.setItem("memeUserId",r.id),localStorage.setItem("memeUserEmail",r.email||""),localStorage.setItem("onboardingComplete","true")),await h(r.id),i("Username registered successfully!"),console.log("[UsernameBalance] Profile created via Edge Function:",c)}catch(c){console.error("Registration error:",c),m("username",{type:"manual",message:"Network error. Please try again."})}},a=p(u)||p(r?.user_metadata?.username),g=r?.user_metadata?.avatar_url||r?.user_metadata?.picture||null;return e.jsxs("div",{className:"onboarding-card flex flex-col items-center gap-6 p-6 max-w-md mx-auto bg-white/80 dark:bg-zinc-900/80 border border-emerald-100 dark:border-zinc-800 shadow-xl rounded-2xl",children:[r&&e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[g&&e.jsx("img",{src:g,alt:"User Avatar",className:"w-20 h-20 rounded-full border-4 border-emerald-400 shadow-md mb-2 bg-white object-cover"}),e.jsx("div",{className:"text-lg font-semibold text-zinc-800 dark:text-zinc-100",children:r.user_metadata?.display_name||r.email})]}),e.jsx("h2",{className:"text-2xl font-bold text-emerald-600 dark:text-emerald-300 mb-2 drop-shadow",children:a?"Update your username":"Choose your username"}),t&&t.meme_points!==null&&e.jsxs("div",{className:"flex flex-wrap justify-center gap-4 mb-4 text-center",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-2xl font-bold text-emerald-400",children:t.meme_points}),e.jsx("span",{className:"text-xs text-neutral-500",children:"Meme Points"})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-2xl font-bold text-emerald-400",children:t.level}),e.jsx("span",{className:"text-xs text-neutral-500",children:"Level"})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-2xl font-bold text-emerald-400",children:t.total_memes||0}),e.jsx("span",{className:"text-xs text-neutral-500",children:"Memes Created"})]})]}),e.jsxs("form",{onSubmit:N(w),className:"w-full flex flex-col gap-3",children:[e.jsx("input",{type:"text",...j("username",{required:"Username is required",pattern:{value:A,message:"3-30 chars, lowercase letters, numbers, _ or -"},onChange:s=>(s.target.value=s.target.value.toLowerCase(),s)}),placeholder:"Enter your username...",defaultValue:u||"",className:"border-2 border-emerald-200 dark:border-emerald-700 rounded-lg px-4 py-3 text-lg bg-white dark:bg-zinc-800 text-zinc-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-emerald-400 shadow-sm transition",disabled:n||a}),f.username&&e.jsx("div",{className:"text-red-500 text-xs font-medium",children:f.username.message}),e.jsx("button",{type:"submit",className:"bg-gradient-to-br from-emerald-500 to-green-500 text-white px-6 py-2 rounded-full font-bold shadow hover:from-emerald-400 hover:to-green-400 hover:shadow-lg transition disabled:opacity-50 text-lg",disabled:n||a,children:a?"Username Set":n?"Registering...":"Register"})]}),d&&e.jsx("div",{className:"text-green-500 text-sm font-semibold",children:d}),d&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl p-8 flex flex-col items-center gap-4 border border-emerald-200 dark:border-emerald-700 max-w-xs",children:[e.jsx("div",{className:"text-2xl text-green-600 dark:text-green-400 font-bold mb-2",children:"Success!"}),e.jsx("div",{className:"text-base text-neutral-700 dark:text-neutral-200 text-center",children:"Your username has been registered. Welcome to the meme community!"}),e.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[e.jsx("a",{href:"/discover",className:"px-5 py-2 rounded-lg bg-gradient-to-r from-emerald-500 to-green-500 text-white font-bold shadow hover:from-emerald-400 hover:to-green-400 transition-colors text-center",children:"Discover Memes"}),e.jsx("a",{href:"/profile",className:"px-5 py-2 rounded-lg border border-emerald-500 text-emerald-600 dark:text-emerald-400 font-bold hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors text-center",children:"View Profile"})]}),e.jsx("button",{onClick:()=>i(null),className:"text-xs text-emerald-600 dark:text-emerald-300 mt-2 underline",children:"Close"})]})}),a&&e.jsx("div",{className:"text-emerald-600 dark:text-emerald-400 text-xs font-medium",children:"You are already onboarded. Welcome back!"})]})};export{D as default};
