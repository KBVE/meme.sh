import{p as i}from"./@nanostores.D3epgRK9.js";import{s as d}from"./supabaseClient.D_vLzryr.js";import{a as f}from"./nanostores.B6d4-zKA.js";const U=f(null),m=f(null),g=i("meme:user:id",void 0),p=i("meme:user:email",void 0),a=i("meme:user:username",void 0);function v(e){return e?JSON.stringify(e):""}function S(e){return e?JSON.parse(e):void 0}const o=i("meme:user:profile",void 0,{encode:v,decode:S});async function P(){try{const{data:{user:e},error:t}=await d.auth.getUser();if(t){console.error("[syncSupabaseUser] Error getting user:",t),c();return}if(e){U.set(e),g.set(e.id),p.set(e.email||void 0);const r=e.user_metadata?.username,n=a.get(),s=r||n;s?(m.set(s),a.set(s),localStorage.setItem("memeUsername",s),localStorage.setItem("memeUserId",e.id),localStorage.setItem("memeUserEmail",e.email||""),localStorage.setItem("isMember","true"),await y(e.id)):(m.set(null),a.set(void 0))}else c()}catch(e){console.error("[syncSupabaseUser] Unexpected error:",e),c()}}function c(){U.set(null),g.set(void 0),p.set(void 0),m.set(null),a.set(void 0),o.set(void 0),typeof window<"u"&&(localStorage.removeItem("memeUsername"),localStorage.removeItem("memeUserId"),localStorage.removeItem("memeUserEmail"),localStorage.removeItem("onboardingComplete"),localStorage.setItem("isMember","false"))}async function y(e,t=!0){if(!e){o.set(void 0);return}try{const{data:r,error:n}=await d.rpc("get_user_balance_context",{p_identifier:e,use_cache:t});if(n){console.error("[syncUserMemeProfile] RPC error:",n),o.set(void 0);return}if(r&&r.length>0){const s=r[0],l={user_id:s.user_id||e,username:s.username||null,role:s.role||null,credits:s.credits??null,khash:s.khash??null,level:s.level??null,created_at:s.created_at||new Date().toISOString(),meme_points:null,total_memes:null,total_likes:null};o.set(l),l.username&&!a.get()&&(a.set(l.username),m.set(l.username),typeof window<"u"&&localStorage.setItem("memeUsername",l.username)),console.log("[syncUserMemeProfile] Profile synced from RPC:",l)}else o.set(void 0),console.log("[syncUserMemeProfile] No profile data returned for identifier:",e)}catch(r){console.error("[syncUserMemeProfile] Failed to fetch profile:",r),o.set(void 0)}}function u(e){return typeof e!="string"?!1:/^[a-z0-9_-]{3,30}$/.test(e)}function E(){const e=m.get(),t=a.get(),r=o.get(),n=!!(u(e)||u(t)),s=!!(r&&(r.credits!==null||r.khash!==null));return n&&s}export{y as a,U as b,o as c,m as d,a as e,E as i,P as s,g as u,u as v};
