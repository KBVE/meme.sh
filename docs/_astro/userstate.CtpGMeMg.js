import{p as c}from"./index.CvL_fmfE.js";import{s as f}from"./supabaseClient.UdoNoOaI.js";import{a as g}from"./index.CMSeyhcG.js";async function S(e){try{return await e()}catch(t){if(t?.message==="Auth session missing!"||t?.name==="AuthSessionMissingError")return null;throw t}}const p=g(null),l=g(null),U=c("meme:user:id",void 0),v=c("meme:user:email",void 0),i=c("meme:user:username",void 0);function h(e){return e?JSON.stringify(e):""}function y(e){return e?JSON.parse(e):void 0}const a=c("meme:user:profile",void 0,{encode:h,decode:y});async function M(){const e=await S(async()=>await f.auth.getSession());if(!e){u();return}const{data:{session:t},error:s}=e;if(s){s.message!=="Auth session missing!"&&console.error("[syncSupabaseUser] Error getting session:",s),u();return}if(!t?.user){u();return}const r=t.user;if(r){p.set(r),U.set(r.id),v.set(r.email||void 0);const o=r.user_metadata?.username,n=i.get(),m=o||n;m?(l.set(m),i.set(m),localStorage.setItem("memeUsername",m),localStorage.setItem("memeUserId",r.id),localStorage.setItem("memeUserEmail",r.email||""),localStorage.setItem("isMember","true"),await _(r.id)):(l.set(null),i.set(void 0))}else u()}function u(){p.set(null),U.set(void 0),v.set(void 0),l.set(null),i.set(void 0),a.set(void 0),typeof window<"u"&&(localStorage.removeItem("memeUsername"),localStorage.removeItem("memeUserId"),localStorage.removeItem("memeUserEmail"),localStorage.removeItem("onboardingComplete"),localStorage.setItem("isMember","false"))}async function _(e,t=!0){if(!e){a.set(void 0);return}try{const{data:s,error:r}=await f.rpc("get_user_balance_context",{p_identifier:e,use_cache:t});if(r){console.error("[syncUserMemeProfile] RPC error:",r),a.set(void 0);return}if(s&&s.length>0){const o=s[0],n={user_id:o.user_id||e,username:o.username||null,role:o.role||null,credits:o.credits??null,khash:o.khash??null,level:o.level??null,created_at:o.created_at||new Date().toISOString(),meme_points:null,total_memes:null,total_likes:null};a.set(n),n.username&&!i.get()&&(i.set(n.username),l.set(n.username),typeof window<"u"&&localStorage.setItem("memeUsername",n.username)),console.log("[syncUserMemeProfile] Profile synced from RPC:",n)}else a.set(void 0),console.log("[syncUserMemeProfile] No profile data returned for identifier:",e)}catch(s){console.error("[syncUserMemeProfile] Failed to fetch profile:",s),a.set(void 0)}}function d(e){return typeof e!="string"?!1:/^[a-z0-9_-]{3,30}$/.test(e)}function P(){const e=l.get(),t=i.get(),s=a.get(),r=!!(d(e)||d(t)),o=!!(s&&(s.credits!==null||s.khash!==null));return r&&o}export{a,l as b,U as c,_ as d,i as e,P as i,M as s,p as u,d as v};
